<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:head>
    </h:head>
    <h:body>

        <ui:composition template="/admin/pricing/index.xhtml">

            <ui:define name="subcontent">

                <h:form>
                    <p:growl id="msg"/>
                    <p:panel>
                        <f:facet name="header">
                            <h:outputText styleClass="fa fa-fw fa-money-bill-wave"></h:outputText>
                            <p:outputLabel class="m-2">Manage For Site Items Fees</p:outputLabel>
                        </f:facet>


                        <p:panelGrid columns="2" class="w-100" >

                            <p:outputLabel value="Select Site" />
                            <p:autoComplete 
                                value="#{itemFeeManager.forSite}" 
                                forceSelection="true" id="acColl"
                                completeMethod="#{institutionController.completeSites}" 
                                var="vt" itemLabel="#{vt.name}" itemValue="#{vt}" 
                                maxResults="10"
                                class="w-100 mb-1"
                                inputStyleClass="form-control">
                                <p:ajax event="itemSelect" 
                                        process="@this" 
                                        update="gpFees gpTotals gpTotalsF" 
                                        listener="#{itemFeeManager.fillForSiteFees()}"></p:ajax>
                            </p:autoComplete>

                            <p:outputLabel value="Select Item" />
                            <p:autoComplete 
                                widgetVar="aIx" 
                                id="acIx" 
                                forceSelection="true" 
                                value="#{itemFeeManager.item}"
                                completeMethod="#{itemController.completeAllServicesAndInvestigations}" 
                                var="ix" 
                                itemLabel="#{ix.name}" 
                                itemValue="#{ix}" 
                                size="30"  
                                class="w-100"
                                maxResults="10"
                                inputStyleClass="w-100">
                                <p:ajax event="itemSelect" 
                                        process="@this" 
                                        update="gpFees gpTotals gpTotalsF" 
                                        listener="#{itemFeeManager.fillForSiteFees()}"></p:ajax>
                            </p:autoComplete>

                            <!-- Display Local Fee for the selected Item and Site -->
                            <p:outputLabel value="Local Fee" />
                            <p:inputText id="localFee" 
                                         value="#{feeValueController.getFeeForLocals(itemFeeManager.item, itemFeeManager.forSite)}" 
                                         class="w-100">
                                <f:convertNumber pattern="#,##0.00" />
                            </p:inputText>

                            <!-- Display Foreigner Fee for the selected Item and Site -->
                            <p:outputLabel value="Foreigner Fee" />
                            <p:inputText id="foreignerFee" 
                                         value="#{feeValueController.getFeeForForeigners(itemFeeManager.item, itemFeeManager.forSite)}" 
                                         class="w-100">
                                <f:convertNumber pattern="#,##0.00" />
                            </p:inputText>

                        </p:panelGrid>

                        <div class="row">
                            <div class="col-md-2">
                                <p:commandButton 
                                    id="btnAddNewFee"
                                    value="Add New Fee" 
                                    process="btnAddNewFee acIx" 
                                    onclick="PF('dlg').show();" 
                                    class="w-100 mt-2 ui-button-success" icon="fa fa-plus">   
                                </p:commandButton>
                            </div>
                        </div>

                        <p:panel header="Current Fees" id="gpFees" class="m-1">
                            <p:dataTable id="tblFees" value="#{itemFeeManager.itemFees}" var="f" rowIndexVar="n" rowKey="#{f.id}" >
                                <p:column headerText="Name" >
                                    <p:inputText id="txtFeeName" value="#{f.name}" class="w-100" >
                                        <p:ajax process="txtFeeName" event="blur" listener="#{itemFeeManager.updateFee(f)}" update=":#{p:resolveFirstComponentWithId('gpTotals',view).clientId} :#{p:resolveFirstComponentWithId('gpTotalsF',view).clientId}" ></p:ajax>
                                    </p:inputText>
                                </p:column>
                                <p:column headerText="Type" >
                                    <p:outputLabel id="txtFeeType" value="#{f.feeType.label}" >
                                    </p:outputLabel>
                                </p:column>
                                <p:column headerText="Discount Allowed" >
                                    <p:selectBooleanButton value="#{f.discountAllowed}" 
                                                           offLabel="Discounts NOT Allowed" 
                                                           onLabel="Discounts Allowed" 
                                                           onIcon="pi pi-check" 
                                                           offIcon="pi pi-times"
                                                           styleClass="#{f.discountAllowed ? 'ui-button-success' : 'ui-button-danger'}">
                                        <p:ajax process="@this" listener="#{itemFeeManager.updateFee(f)}" />
                                    </p:selectBooleanButton>


                                </p:column>
                                <p:column headerText="For" >
                                    <h:panelGroup rendered="#{f.institution ne null}" >
                                        <p:outputLabel value="#{f.institution.name}" >
                                        </p:outputLabel>
                                        <p:spacer height="1" width="2" ></p:spacer>

                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{f.speciality ne null}" >
                                        <p:outputLabel value="#{f.speciality.name}" >
                                        </p:outputLabel>
                                        <p:spacer height="1" width="2" ></p:spacer>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{f.department ne null}" >
                                        <p:outputLabel value=" - " ></p:outputLabel>
                                        <p:outputLabel value="#{f.department.name}" >
                                        </p:outputLabel>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{f.staff ne null}" >
                                        <p:outputLabel value=" - " ></p:outputLabel>
                                        <p:outputLabel value="#{f.staff.person.nameWithTitle}" >
                                        </p:outputLabel>
                                    </h:panelGroup>
                                </p:column>
                                <p:column headerText="Value" >
                                    <p:inputText id="txtFeeVal" value="#{f.fee}" class="w-100" >
                                        <p:ajax process="txtFeeVal" event="blur" listener="#{itemFeeManager.updateFee(f)}" update=":#{p:resolveFirstComponentWithId('gpTotals',view).clientId} :#{p:resolveFirstComponentWithId('gpTotalsF',view).clientId}" ></p:ajax>
                                    </p:inputText>
                                </p:column>
                                <p:column headerText="Value for Foreigners" >
                                    <p:inputText id="txtFfeeVal" value="#{f.ffee}"  class="w-100" >
                                        <p:ajax process="txtFfeeVal" event="blur" listener="#{itemFeeManager.updateFee(f)}"  update=":#{p:resolveFirstComponentWithId('gpTotalsF',view).clientId} :#{p:resolveFirstComponentWithId('gpTotalsF',view).clientId}"></p:ajax>
                                    </p:inputText>
                                </p:column>
                                <p:column headerText="Actions" >
                                    <p:commandButton id="cmdRemove" value="Remove" ajax="false" action="#{itemFeeManager.removeFee()}" >
                                        <f:setPropertyActionListener value="#{f}" target="#{itemFeeManager.removingFee}" ></f:setPropertyActionListener>
                                    </p:commandButton>
                                </p:column>



                            </p:dataTable>
                        </p:panel>

                    </p:panel>

                </h:form>
            </ui:define>

        </ui:composition>

    </h:body>
</html>
