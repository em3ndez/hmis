<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ch="http://xmlns.jcp.org/jsf/composite/channel"
      xmlns:pa="http://xmlns.jcp.org/jsf/composite/paymentMethod"
      xmlns:au="http://xmlns.jcp.org/jsf/composite/autocomplete"
      xmlns:pat="http://xmlns.jcp.org/jsf/composite/patient"
      xmlns:common="http://xmlns.jcp.org/jsf/composite/ezcomp/common"
      xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">

    <h:head>
        <title>Channel Booking By Date</title>
    </h:head>

    <h:body>

        <f:metadata>
            <f:viewParam name="fromDate" value="#{bookingControllerViewScope.fromDate}">
                <f:converter converterId="javax.faces.DateTime"/>
            </f:viewParam>
            <f:viewParam name="toDate" value="#{bookingControllerViewScope.toDate}">
                <f:converter converterId="javax.faces.DateTime"/>
            </f:viewParam>
        </f:metadata>

        <ui:composition template="/resources/template/template.xhtml">


            <ui:define name="content">


                <h:panelGroup rendered="#{!bookingControllerViewScope.printPreview}" >
                    <h:form >
                        <div class="container-fluid" >
                            <div class="row bg-light my-2 py-2 shadow-sm navbar" >
                                <div class="col-12 p-2 d-flex" >
                                    <div class="d-flex align-items-center w-100">
                                        <div class="d-flex align-items-center ">
                                            <p:outputLabel value="From"></p:outputLabel>
                                            <p:calendar id="fromDate" value="#{bookingControllerViewScope.fromDate}" size="10" class="mx-2"></p:calendar>
                                            <p:outputLabel value="To" ></p:outputLabel>
                                            <p:calendar id="toDate" value="#{bookingControllerViewScope.toDate}" size="10"  class="mx-2"></p:calendar>
                                        </div>

                                        <div class="d-flex align-items-center w-100">
                                            <p:inputText id="txtFilter" class="w-100" value="#{bookingControllerViewScope.sessionInstanceFilter}" placeholder="Search">
                                                <p:ajax event="keyup" process="@this" update="groupFilteredSessions gdManageBookings panelBookingDetails" listener="#{bookingControllerViewScope.filterSessionInstances}"></p:ajax>
                                            </p:inputText>

                                        </div>
                                        <div class="d-flex align-items-center w-100">
                                            <p:commandButton value="Today" action="#{bookingControllerViewScope.addToDayToToDate()}" ajax="false" class="mx-1 ui-button-info"></p:commandButton>
                                            <p:commandButton value="+1" action="#{bookingControllerViewScope.addSingleDateToToDate()}" ajax="false" class="mx-1 ui-button-info"></p:commandButton>
                                            <p:commandButton value="+2" action="#{bookingControllerViewScope.addTwoDays()}" ajax="false" class="mx-1 ui-button-info"></p:commandButton>
                                            <p:commandButton value="+7" action="#{bookingControllerViewScope.addSevenDays()}" ajax="false" class="mx-1 ui-button-info"></p:commandButton>
                                            <p:commandButton value="+1 Month" action="#{bookingControllerViewScope.addMonth()}" ajax="false" class="mx-1 ui-button-info"></p:commandButton>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end ">
                                        <div class="d-flex align-items-center">
                                            <p:commandButton 
                                                ajax="false" 
                                                title="Completed" 
                                                icon="fa fa-check" 
                                                styleClass="ui-button-secondary mx-1" 
                                                action="#{bookingControllerViewScope.listCompletedSesionInstances()}" />

                                            <!-- View Ongoing Session Data Button -->
                                            <p:commandButton 
                                                ajax="false" 
                                                title="Ongoing"
                                                icon="fa fa-sync-alt" 
                                                styleClass="ui-button-success mx-1" 
                                                action="#{bookingControllerViewScope.listOngoingSesionInstances()}" />

                                            <!-- List Pending Button -->
                                            <p:commandButton 
                                                ajax="false" 
                                                title="Pending"
                                                icon="fa fa-hourglass-start" 
                                                styleClass="ui-button-primary mx-1" 
                                                action="#{bookingControllerViewScope.listPendingSesionInstances()}" />

                                            <!-- List Cancelled Button -->
                                            <p:commandButton 
                                                title="Cancelled"
                                                ajax="false" 
                                                icon="fa fa-times-circle" 
                                                styleClass="ui-button-danger mx-1" 
                                                action="#{bookingControllerViewScope.listCancelledSesionInstances()}" />


                                            <!-- List All Button -->
                                            <p:commandButton 
                                                ajax="false" 
                                                title="All"
                                                icon="fa fa-list" 
                                                styleClass="ui-button-primary mx-1" 
                                                action="#{bookingControllerViewScope.listAllSesionInstances()}" />


                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="row" >
                                <div class="col-7" >
                                    <h:panelGroup id="groupFilteredSessions" >
                                        <p:dataTable 
                                            value="#{bookingControllerViewScope.sessionInstancesFiltered}"  
                                            var="s"
                                            selectionMode="single"
                                            selection="#{bookingControllerViewScope.selectedSessionInstance}"
                                            rowKey="#{s.id}"
                                            class="w-100">

                                            <p:ajax 
                                                event="rowSelect" 
                                                process="@this"
                                                update=":#{p:resolveFirstComponentWithId('panelBookingDetails',view).clientId} :#{p:resolveFirstComponentWithId('gdManageBookings',view).clientId}"
                                                listener="#{bookingControllerViewScope.sessionInstanceSelected()}" />



                                            <p:column >
                                                <div class="d-flex align-items-center w-100">
                                                    <div>
                                                        <i class="fa-solid fa-user-doctor" style="font-size: 26pt;margin-right: 28px"></i>
                                                    </div>
                                                    <div>
                                                        <h:outputText value="#{s.staff.person.nameWithTitle}" style="font-weight: bolder" /><br/>
                                                        <h:outputText value="(#{s.staff.speciality.name})" />
                                                        <br/>

                                                        <div>
                                                            <h:outputText value="#{s.sessionDate}"  >
                                                                <f:convertDateTime pattern="#{sessionController.applicationPreference.shortDateFormat}" />
                                                            </h:outputText>

                                                            <h:outputText class="mx-2" value="#{s.startingTime}">
                                                                <f:convertDateTime pattern="hh:mm a"/>
                                                            </h:outputText>
                                                            <h:outputText class="mx-2" value="#{s.endingTime}">
                                                                <f:convertDateTime pattern="hh:mm a"/>
                                                            </h:outputText>

                                                            <!-- Conditional message for delayed start time -->
                                                            <h:panelGroup rendered="#{s.startingTime gt s.originatingSession.startingTime}">
                                                                <br/>
                                                                <h:outputText class="mr-2 text-danger" value="Delayed. Original starting time is ">
                                                                </h:outputText>
                                                                <h:outputText class="mr-2 text-danger" value="#{s.originatingSession.startingTime}">
                                                                    <f:convertDateTime pattern="hh:mm a"/>
                                                                </h:outputText>
                                                            </h:panelGroup>

                                                            <!-- Conditional message for early start time -->
                                                            <h:panelGroup rendered="#{s.startingTime lt s.originatingSession.startingTime}">
                                                                <br/>
                                                                <h:outputText class="mr-2 text-warning" value="Early. Original starting time is ">
                                                                </h:outputText>
                                                                <h:outputText class="mr-2 text-warning" value="#{s.originatingSession.startingTime}">
                                                                    <f:convertDateTime pattern="hh:mm a"/>
                                                                </h:outputText>
                                                            </h:panelGroup>
                                                        </div>
                                                        <div class="d-flex align-items-center justify-content-between">
                                                            <h:outputText rendered="true" value="#{s.name}" style="font-weight: bolder;font-size: 10pt" />
                                                            <br/>
                                                            <p:badge class="d-flex justify-content-end m-2" rendered="#{!s.started and !s.cancelled}" value="Room: #{s.roomNo}"  severity="primary" ></p:badge>
                                                            <p:badge rendered="#{s.started}" value="Room: #{s.roomNo}"  severity="success" styleClass="mr-2"></p:badge>
                                                            <p:badge rendered="#{s.completed}" value="Room: #{s.roomNo}"  severity="warning" styleClass="mr-2"></p:badge>
                                                            <p:badge rendered="#{s.cancelled}" value="Room: #{s.roomNo}"  severity="danger" styleClass="mr-2"></p:badge>
                                                        </div>

                                                        <br/>
                                                        <span class="text-center mx-1" > 
                                                            <h:panelGroup rendered="#{s.originatingSession.paidAppointmentsOnly}">
                                                                <p:badge value="Paid Appointments Only" severity="danger"></p:badge>
                                                            </h:panelGroup>
                                                        </span>
                                                    </div>
                                                </div>
                                            </p:column>
                                            <p:column>
                                                <div class="d-flex align-items-center justify-content-between ">
                                                    <div class="d-flex align-items-center">
                                                        <div class="text-center">
                                                            <h:outputLabel style="font-weight: bolder" value="M"/><br/>
                                                            <p:badge value="#{s.maxNo}" size="large" styleClass="mr-2"></p:badge>
                                                        </div>
                                                        <div class="text-center mx-4">
                                                            <h:outputLabel style="font-weight: bolder" value="A"/><br/>
                                                            <p:badge value="#{s.maxNo - s.bookedPatientCount}" size="large" styleClass="mr-2"></p:badge>
                                                        </div>
                                                        <div class="text-center">
                                                            <h:outputLabel style="font-weight: bolder" value="N"/><br/>
                                                            <p:badge value="#{s.bookedPatientCount + 1}" size="large" styleClass="mr-2"></p:badge>
                                                        </div>
                                                    </div>

                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="mx-4">
                                                            <div class="d-flex align-items-center">
                                                                <span class="text-center mx-1">
                                                                    <h:outputText value="P" style="font-weight: bolder"/><br/>
                                                                    <p:badge value="#{s.paidPatientCount != null ? s.paidPatientCount : ' '}" severity="warning" size="large" styleClass="mr-2"></p:badge>
                                                                </span>
                                                                <span class="text-center mx-1"> 
                                                                    <h:outputText style="font-weight: bolder" value="B"/><br/>
                                                                    <p:badge value="#{s.bookedPatientCount != null ? s.bookedPatientCount : ' '}" severity="warning" size="large" styleClass="mr-2"></p:badge>
                                                                </span>
                                                                <span class="text-center mx-1" > 
                                                                    <h:outputText style="font-weight: bolder" value="C"/><br/>
                                                                    <p:badge value="#{s.completedPatientCount != null ? s.completedPatientCount : ' '}" severity="danger" size="large" styleClass="mr-2"></p:badge>
                                                                </span>
                                                                <span class="text-center mx-1" > 
                                                                    <h:outputLabel /><br/>
                                                                    <p:commandButton 
                                                                        icon="fas fa-cog"
                                                                        styleClass="rounded-button ui-button-secondary mr-2"
                                                                        action="#{bookingControllerViewScope.navigateToManageSessionInstance(s)}" 
                                                                        ajax="false" >
                                                                    </p:commandButton>
                                                                </span>
                                                            </div>
                                                        </span>
                                                    </div>



                                                </div>
                                            </p:column>
                                        </p:dataTable>
                                    </h:panelGroup>
                                </div>
                                <div class="col-5" > 
                                    <div class="sticky-top shadow " style="max-height: 100vh; overflow-y: auto;z-index: 100;">
                                        <common:patient_details_view_scope
                                            controller="#{bookingControllerViewScope}"/>

                                        <p:panel class="my-1">
                                            <h:panelGrid id="gdManageBookings" class="w-100 m-2" columns="2"  >
                                                <f:facet name="header">
                                                    <p:row>
                                                        <p:column  colspan="2" >
                                                            <h:outputText styleClass="fa-solid fa-money-bill-wave"/>
                                                            <h:outputText class="mx-4" value="Payment Details"/>
                                                        </p:column>
                                                    </p:row>
                                                </f:facet>
                                                <f:facet name="footer">
                                                    <p:row>
                                                        <p:column colspan="2" >
                                                            <p:commandButton
                                                                id="btnAdd"
                                                                value="Add Normal Booking"
                                                                ajax="false"
                                                                update="gpThisBookingDetails"
                                                                class="ui-button-info "
                                                                icon="pi pi-check"
                                                                action="#{bookingControllerViewScope.addNormalChannelBooking}" >
                                                            </p:commandButton>
                                                            <p:commandButton
                                                                id="btnAddReserved"
                                                                value="Add Reserved Booking"
                                                                ajax="false"
                                                                update="gpThisBookingDetails"
                                                                class="ui-button-warning m-2"
                                                                icon="pi pi-bookmark"
                                                                action="#{bookingControllerViewScope.addReservedChannelBooking}" > <!-- Assuming a different action for reserved booking -->
                                                            </p:commandButton>
                                                        </p:column>
                                                    </p:row>
                                                </f:facet>



                                                <p:outputLabel value="Amount"/>

                                                <h:panelGroup class="mx-2 my-2" id="lblSessionTotal" style="font-weight: bolder">
                                                    <p:outputLabel
                                                        value="#{bookingControllerViewScope.selectedSessionInstance.originatingSession.totalForForeigner}"
                                                        rendered="#{bookingControllerViewScope.foriegn}">
                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                    </p:outputLabel>
                                                    <p:outputLabel
                                                        value="#{bookingControllerViewScope.feeTotalForSelectedBill}"
                                                        rendered="#{!bookingControllerViewScope.foriegn}">

                                                    </p:outputLabel>
                                                </h:panelGroup>
                                                <p:outputLabel value="Tenderd Amount"/>

                                                <h:panelGroup class="w-100 my-2" style="font-weight: bolder">
                                                    <p:inputText id="paid" value="#{bookingControllerViewScope.strTenderedValue}">
                                                        <p:ajax event="keyup" process=" paid" update="balance"/>
                                                    </p:inputText>
                                                </h:panelGroup>

                                                <p:outputLabel value="Balance"/>

                                                <h:panelGroup id="balance" class="w-100 my-2" style="font-weight: bolder">
                                                    <p:outputLabel value="#{bookingControllerViewScope.cashBalance}"/>
                                                </h:panelGroup>

                                                <h:outputLabel value="Foriegner"/>
                                                <p:selectBooleanCheckbox class="w-75" id="f" value="#{bookingControllerViewScope.foriegn}">
                                                    <f:ajax event="change" execute="@this" render="lblSessionTotal panelBookingDetails"/>
                                                </p:selectBooleanCheckbox>



                                                <p:outputLabel value="Payment Method"/>

                                                <h:panelGroup>
                                                    <p:selectOneMenu class="w-75" autoWidth="false" id="cmbPs" value="#{bookingControllerViewScope.paymentMethod}">
                                                        <f:selectItem itemLabel="Select Payment Method" ></f:selectItem>
                                                        <f:selectItems value="#{enumController.paymentMethodsForOpdBilling}"/>
                                                        <f:ajax execute="@this" render="gdManageBookings :#{p:resolveFirstComponentWithId('lblSessionTotal',view).clientId} paymentDetails" event="change" listener="#{bookingControllerViewScope.generateSessions}" />
                                                    </p:selectOneMenu>
                                                    <h:outputScript>
                                                        $(document.getElementById('form:cmbPs_focus')).keypress(function (event) {
                                                        var keycode = (event.keyCode ? event.keyCode : event.which);
                                                        alert("sdf");
                                                        if (keycode == '13') {
                                                        document.getElementById("form:txtSearch3").focus();
                                                        return false;
                                                        }

                                                        });
                                                    </h:outputScript>
                                                </h:panelGroup>


                                                <p:outputLabel value="Discount Scheme"/>

                                                <p:selectOneMenu class="w-75" autoWidth="false" id="cmbPs2" value="#{bookingControllerViewScope.paymentScheme}">
                                                    <f:selectItem itemLabel="Select Discount Scheme"/>
                                                    <f:selectItems value="#{paymentSchemeController.paymentSchemesForChannel}"
                                                                   var="paysch" itemLabel="#{paysch.name}" itemValue="#{paysch}"  />
                                                    <p:ajax process="@this"
                                                            update="lblSessionTotal"
                                                            event="change"
                                                            listener="#{bookingControllerViewScope.changeListener()}"/>
                                                </p:selectOneMenu>
                                            </h:panelGrid>

                                            <h:panelGroup id="paymentDetails" class="my-2">

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Agent'}">
                                                    <p:column colspan="2" >
                                                        <h:outputLabel id="agent" value="Agent"   />
                                                    </p:column>
                                                </p:row>
                                                <p:row  rendered="#{bookingControllerViewScope.paymentMethod eq 'Agent'}">
                                                    <p:column >
                                                        <h:outputLabel  value="Agent Details"   />
                                                    </p:column>
                                                    <p:column  >
                                                        <p:autoComplete class="w-75" id="agent2" forceSelection="true"
                                                                        value="#{bookingControllerViewScope.institution}"  completeMethod="#{agencyController.completeAgency}" var="ix"
                                                                        itemLabel="#{ix.name}" itemValue="#{ix}" size="38" >
                                                            <f:ajax  event="itemSelect" execute="@this"  render=" ballance2 lblSessionTotal agRefLbl agRefTxt :#{p:resolveFirstComponentWithId('agRefLbl',view).clientId} :#{p:resolveFirstComponentWithId('tblAgentBooks',view).clientId} gdManageBookings" listener="#{bookingControllerViewScope.validateAgentBalance()}"/>
                                                            <!--<p:ajax event="click" process="@this" update=":#{p:resolveFirstComponentWithId('agRefLbl',view).clientId} :#{p:resolveFirstComponentWithId('tblAgentBooks',view).clientId} gdManageBookings" />-->
                                                            <p:column>#{ix.institutionCode}</p:column>
                                                            <p:column>#{ix.name}</p:column>
                                                        </p:autoComplete>
                                                    </p:column>
                                                </p:row>

                                                <p:row  rendered="#{bookingControllerViewScope.paymentMethod eq 'Agent'}">
                                                    <p:column>
                                                        <p:outputLabel for="agRefTxt" value="Agent Ref No"/>
                                                    </p:column>
                                                    <p:column >
                                                        <p:inputText size="38" autocomplete="off" id="agRefTxt" value="#{bookingControllerViewScope.agentRefNo}"
                                                                     style="display: #{bookingControllerViewScope.paymentMethod eq 'Agent' ? 'block' : 'none'} ; "/>
                                                    </p:column>
                                                </p:row>

                                                <p:row  rendered="#{bookingControllerViewScope.paymentMethod eq 'Agent'}">
                                                    <p:column>
                                                        <p:outputLabel  value="Agent Balance"/>
                                                    </p:column>
                                                    <p:column >
                                                        <h:outputLabel id="ballance2" value="#{bookingControllerViewScope.institution.ballance}"
                                                                       style="display: #{bookingControllerViewScope.paymentMethod eq 'Agent' ? 'block' : 'none'} ; "/>
                                                    </p:column>
                                                </p:row>

                                                <p:row  rendered="#{bookingControllerViewScope.paymentMethod eq 'Agent'}">
                                                    <p:column colspan="2">
                                                        <p:dataTable class="w-100" id="tblAgentBooks"
                                                                     emptyMessage="No Referance Books"
                                                                     value="#{bookingControllerViewScope.institution.agentReferenceBooks}" var="a">
                                                            <f:facet name="header" >
                                                                <p:outputLabel value="Agent Referance Number Details" ></p:outputLabel>
                                                            </f:facet>
                                                            <p:column headerText="S.R.N.">
                                                                <p:outputLabel value="#{a.startingReferenceNumber}">
                                                                    <f:convertNumber pattern="00000" />
                                                                </p:outputLabel>
                                                            </p:column>
                                                            <p:column headerText="E.R.N.">
                                                                <p:outputLabel value="#{a.endingReferenceNumber}">
                                                                    <f:convertNumber pattern="00000" />
                                                                </p:outputLabel>
                                                            </p:column>
                                                        </p:dataTable>

                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Card'}">
                                                    <p:column colspan="2" >
                                                        <h:outputLabel id="card" value="Card Payment"   />
                                                    </p:column>
                                                </p:row>

                                                <p:row  rendered="#{bookingControllerViewScope.paymentMethod eq 'Card'}">
                                                    <p:column><p:outputLabel id="creditCardbnkLbl" value="Select Bank" /></p:column>
                                                    <p:column>
                                                        <p:selectOneMenu class="w-75" autoWidth="false" id="creditCardSlc" value="#{bookingControllerViewScope.paymentMethodData.creditCard.institution}">
                                                            <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                                            <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                                        </p:selectOneMenu>
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Card'}">
                                                    <p:column>
                                                        <p:outputLabel for="creditCardTxt" value="Card Ref. No"/>
                                                    </p:column>
                                                    <p:column>
                                                        <p:inputText class="w-75" id="creditCardTxt" autocomplete="off" value="#{bookingControllerViewScope.paymentMethodData.creditCard.no}"
                                                                     style="display: #{bookingControllerViewScope.paymentMethod ne 'Card' ? 'none' : 'block'} ;"/>
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Cheque'}">
                                                    <p:column colspan="2" >
                                                        <h:outputLabel  value="Cheque Payment"   />
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Cheque'}">
                                                    <p:column><p:outputLabel id="lblCheque" value="Cheque No" /></p:column>
                                                    <p:column >
                                                        <p:inputText size="38" id="chequNo" autocomplete="off" value="#{bookingControllerViewScope.paymentMethodData.cheque.no}"
                                                                     style="display: #{bookingControllerViewScope.paymentMethod ne 'Cheque' ? 'none' : 'block'};" />
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Cheque'}">
                                                    <p:column><p:outputLabel id="lblBank" value="Select Bank" /></p:column>
                                                    <p:column >
                                                        <p:selectOneMenu style="width: 335px" autoWidth="false" id="bankSel" value="#{bookingControllerViewScope.paymentMethodData.cheque.institution}">
                                                            <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                                            <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                                        </p:selectOneMenu>
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Cheque'}">
                                                    <p:column><p:outputLabel id="lblChequeDate" value="Cheque Date" /></p:column>
                                                    <p:column >
                                                        <p:calendar size="38" id="ChequeDate" value="#{bookingControllerViewScope.paymentMethodData.cheque.date}" pattern="dd MMMM yyyy"
                                                                    style="display: #{bookingControllerViewScope.paymentMethod ne 'Cheque' ? 'none' : 'block'};" />
                                                    </p:column>
                                                </p:row>




                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Staff'}">
                                                    <p:column><p:outputLabel id="staff" value="Staff" /></p:column>
                                                    <p:column>
                                                        <h:panelGroup id="autoStaff" style="display: #{bookingControllerViewScope.paymentMethod eq 'Staff' ? 'block' : 'none'};">

                                                            <p:autoComplete  
                                                                minQueryLength="2"
                                                                forceSelection="true" 
                                                                value="#{bookingControllerViewScope.toStaff}" 
                                                                id="creditStaff"
                                                                completeMethod="#{staffController.completeStaff}" 
                                                                var="mys" 
                                                                class="w-100"
                                                                placeholder="Staff (Type at least 4 letters to search)"
                                                                inputStyleClass="form-control"
                                                                itemLabel="#{mys.person.name}" 
                                                                itemValue="#{mys}"
                                                                size="10">
                                                                <p:column headerText="Name" style="padding: 2px;">
                                                                    <h:outputText value="#{mys.person.nameWithTitle}" ></h:outputText>
                                                                </p:column>
                                                                <p:column headerText="EPF" style="padding: 2px;">
                                                                    <h:outputText value="#{mys.epfNo}" ></h:outputText>
                                                                </p:column>
                                                                <p:column headerText="Credit Entitlement" style="padding: 2px;">
                                                                    <h:outputText value="#{mys.creditLimitQualified}" >
                                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                                    </h:outputText>
                                                                </p:column>
                                                                <p:column  headerText="Credit Utilized" style="padding: 2px;">
                                                                    <h:outputText value="#{mys.currentCreditValue}" >
                                                                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                                    </h:outputText>
                                                                </p:column>

                                                            </p:autoComplete>
                                                        </h:panelGroup>
                                                    </p:column>
                                                </p:row>



                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Slip'}">
                                                    <p:column colspan="2" >
                                                        <h:outputLabel  value="Slip Payment"   />
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Slip'}">
                                                    <p:column><p:outputLabel id="slipLblBank" value="Select Bank" /></p:column>
                                                    <p:column>
                                                        <p:selectOneMenu class="w-75" autoWidth="false" id="slipSelBank" value="#{bookingControllerViewScope.paymentMethodData.slip.institution}">
                                                            <f:selectItem itemLabel="Select Bank" noSelectionOption="true"/>
                                                            <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}" />
                                                        </p:selectOneMenu>
                                                    </p:column>
                                                </p:row>

                                                <p:row rendered="#{bookingControllerViewScope.paymentMethod eq 'Slip'}">
                                                    <p:column><p:outputLabel id="slipLblDate" value="Slip Date" /></p:column>
                                                    <p:column>
                                                        <p:datePicker  class="w-100"
                                                                       showTime="true"
                                                                       showButtonBar="true"
                                                                       timeInput="true" id="date" value="#{bookingControllerViewScope.paymentMethodData.slip.date}" pattern="dd MMMM yyyy"
                                                                       style="display: #{bookingControllerViewScope.paymentMethod ne 'Slip' ? 'none' : 'block'};" />
                                                    </p:column>
                                                </p:row>

                                                <p:row
                                                    class="row my-1 w-100" rendered="#{bookingControllerViewScope.paymentMethod eq 'MultiplePaymentMethods'}" 
                                                    >
                                                    <pa:multiple_payment_methods paymentMethodData="#{bookingControllerViewScope.paymentMethodData}" controller="#{bookingControllerViewScope}" class="w-100"/>

                                                </p:row>

                                            </h:panelGroup>


                                        </p:panel>
                                        <p:panel>
                                            <p:row >
                                                <p:column >
                                                    <p:outputLabel  value="Item" ></p:outputLabel>
                                                </p:column>
                                                <p:column >
                                                    <p:selectOneMenu class="w-75 mx-1" autoWidth="false" id="lstItems" value="#{bookingControllerViewScope.itemToAddToBooking}" >
                                                        <f:selectItem itemLabel="Select" ></f:selectItem>
                                                        <f:selectItems  value="#{bookingControllerViewScope.itemsAvailableToAddToBooking}" var="iata" itemValue="#{iata}"  itemLabel="#{iata.name}" ></f:selectItems>
                                                        <p:ajax event="change" process="lstItems" update="lblSessionTotal :#{p:resolveFirstComponentWithId('gpFeeTotal',view).clientId}" listener="#{bookingControllerViewScope.fillFees}" ></p:ajax>
                                                    </p:selectOneMenu>
                                                </p:column>
                                                <p:column >
                                                    <p:commandButton 
                                                        id="btnAddItem"
                                                        process="lstItems btnAddItem"
                                                        value="Add Item" 
                                                        icon="fas fa-plus"
                                                        class="ui-button-success"
                                                        action="#{bookingControllerViewScope.addItemToBooking}"
                                                        update="lblSessionTotal :#{p:resolveFirstComponentWithId('gpFeeTotal',view).clientId} :#{p:resolveFirstComponentWithId('lstAddedItems',view).clientId} lstItems"
                                                        ></p:commandButton>
                                                </p:column>
                                            </p:row>
                                        </p:panel>
                                        <p:panel id="lstAddedItems" rendered="#{bookingControllerViewScope.itemsAddedToBooking.size() ne 0}">
                                            <ui:repeat  value="#{bookingControllerViewScope.itemsAddedToBooking}" var="item">
                                                <div class="row">
                                                    <div class="d-flex justify-content-between align-items-center m-1">
                                                        <h6>#{item.name}</h6>
                                                        <h6>#{item.itemFee.fee}</h6>
                                                        <p:commandButton id="btnRemoveAdditem" icon="fas fa-trash" class="ui-button-danger" action="#{bookingControllerViewScope.removeAddedAditionalItems(item)}" process="btnRemoveAdditem" update=":#{p:resolveFirstComponentWithId('lstAddedItems',view).clientId}"/>
                                                    </div>
                                                </div>
                                            </ui:repeat>

                                        </p:panel>

                                        <p:panelGrid id="panelBookingDetails" class="w-100 mt-1">
                                            <f:facet name="header">
                                                <p:row>
                                                    <p:column colspan="2" class="w-100" style="text-align: left" >
                                                        <h:outputText styleClass="fa-solid fa-calendar-plus"/>
                                                        <h:outputText class="mx-4" value="Booking Details"/>
                                                    </p:column>
                                                </p:row>

                                            </f:facet>
                                            <p:row>
                                                <p:column><p:outputLabel value="Speciality" /></p:column>
                                                <p:column><p:outputLabel value="#{bookingControllerViewScope.speciality.name}" /></p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Consultant" /></p:column>
                                                <p:column><p:outputLabel value="#{bookingControllerViewScope.staff.person.nameWithTitle}" /></p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Session" /></p:column>
                                                <p:column><p:outputLabel value="#{bookingControllerViewScope.selectedSessionInstance.name}" /></p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Date" /></p:column>
                                                <p:column>
                                                    <p:outputLabel value="#{bookingControllerViewScope.selectedSessionInstance.sessionDate}">
                                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}" />
                                                    </p:outputLabel>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Time" /></p:column>
                                                <p:column>
                                                    <p:outputLabel value="#{bookingControllerViewScope.selectedSessionInstance.originatingSession.startingTime}">
                                                        <f:convertDateTime pattern="#{sessionController.applicationPreference.longTimeFormat}" />
                                                    </p:outputLabel>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Reserved Numbers" /></p:column>
                                                <p:column>
                                                    <p:outputLabel value="#{bookingControllerViewScope.selectedSessionInstance.originatingSession.reserveNumbers}">
                                                    </p:outputLabel>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column><p:outputLabel value="Total Fee" /></p:column>
                                                <p:column >
                                                    <h:panelGroup id="gpFeeTotal">
                                                        <p:outputLabel  rendered="#{!bookingControllerViewScope.foriegn}"
                                                                        value="#{bookingControllerViewScope.feeTotalForSelectedBill}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </p:outputLabel>
                                                        <p:outputLabel rendered="#{bookingControllerViewScope.foriegn}"
                                                                       value="#{bookingControllerViewScope.feeTotalForSelectedBill}">
                                                            <f:convertNumber pattern="#,##0.00" />
                                                        </p:outputLabel>
                                                    </h:panelGroup>
                                                </p:column>
                                            </p:row>
                                            <p:row>
                                                <p:column colspan="2">
                                                    <p:dataTable value="#{bookingControllerViewScope.selectedItemFees}" var="i" >
                                                        <p:column headerText="Name">
                                                            <h:outputLabel value="#{i.name}"/> 
                                                        </p:column>
                                                        <p:column headerText="Fee Type">
                                                            #{i.feeType.label}
                                                        </p:column>
                                                        <p:column headerText="Fee for">
                                                            <h:outputLabel rendered="#{i.speciality.name ne null}" value="#{i.speciality.name} - "></h:outputLabel>

                                                            <h:outputLabel rendered="#{i.staff.person.name ne null}"  value=" #{i.staff.person.name}"></h:outputLabel>

                                                            <h:outputLabel rendered="#{i.institution.name ne null}"  value="#{i.institution.name} - "></h:outputLabel>

                                                            <h:outputLabel rendered="#{i.department.name ne null}"  value=" #{i.department.name}"></h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Local Fee" rendered="#{!bookingControllerViewScope.foriegn}">
                                                            <h:outputText value="#{i.fee}" >
                                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                            </h:outputText>
                                                        </p:column>
                                                        <p:column headerText="Foreign Fee" rendered="#{bookingControllerViewScope.foriegn}">
                                                            <h:outputText value="#{i.ffee}" >
                                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                            </h:outputText>
                                                        </p:column>
                                                    </p:dataTable>
                                                </p:column>

                                            </p:row>
                                        </p:panelGrid>


                                    </div>
                                </div>
                            </div>
                        </div>  
                    </h:form >
                </h:panelGroup>


                <h:panelGroup rendered="#{bookingControllerViewScope.printPreview}" >

                    <h:form>

                        <div class="row">
                            <div>
                                <div class="row w-100">
                                    <div class="d-flex align-items-center justify-content-end">
                                        <div>
                                            <p:commandButton 
                                                value="Print" 
                                                ajax="false" 
                                                class="ui-button-info"
                                                icon="fa fa-print"
                                                action="#"
                                                disabled="#{bookingControllerViewScope.printingBill.balance ne 0.0 or !bookingControllerViewScope.settleSucessFully}">
                                                <p:printer 
                                                    target="gpBillPreview" >
                                                </p:printer>
                                            </p:commandButton>
                                        </div>
                                        <div class="d-flex justify-content-end">

                                            <p:outputLabel value="Paper Type" class="m-2"></p:outputLabel>
                                            <p:selectOneMenu 
                                                value="#{bookingControllerViewScope.departmentPreference.channelBillPaperType}" 
                                                class="m-1" 
                                                style="width: 13em;">
                                                <f:selectItem itemLabel="Please Select Paper Type" />
                                                <f:selectItems value="#{enumController.paperTypes}" />
                                            </p:selectOneMenu>
                                            <p:commandButton 
                                                ajax="false" 
                                                icon="fa fa-sync-alt" 
                                                class="ui-button m-1" 
                                                title="Redraw Bill">
                                            </p:commandButton>
                                        </div>

                                        <div>
                                            <p:commandButton 
                                                value="Back" 
                                                icon="fa fa-redo" 
                                                class="ui-button-success" 
                                                action="#{bookingControllerViewScope.navigateBackToBookingsFromBillSession()}" 
                                                ajax="false" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div >
                                    <h:panelGroup id="gpBillPreview">
                                        <ui:repeat value="#{bookingControllerViewScope.departmentPreference.channellingBillCopiesList}" var="copy">
                                            <h:panelGroup rendered="#{bookingControllerViewScope.departmentPreference.channelBillPaperType eq 'PosPaper'}" >
                                                <ez:bmsChannelBill  bill="#{bookingControllerViewScope.printingBill}"/>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{bookingControllerViewScope.departmentPreference.channelBillPaperType eq 'FiveFivePaper'}" >
                                                <ez:bms5x5ChannelBill bill="#{bookingControllerViewScope.printingBill}" payments="#{bookingControllerViewScope.payments}"/> 
            <!--                                <bg:fiveFiveCCBill_CC bill="#{bookingControllerViewScope.printingBill}"/>  -->
                                            </h:panelGroup>
                                        </ui:repeat>
                                    </h:panelGroup>
                                </div>
                            </div>
                        </div>


                    </h:form>





                </h:panelGroup>


            </ui:define>
        </ui:composition>
    </h:body>
</html>